var y=class extends Error{},u=class extends y{},w=class extends y{};var d=null;typeof WebSocket<"u"?d=WebSocket:typeof MozWebSocket<"u"?d=MozWebSocket:typeof global<"u"?d=global.WebSocket||global.MozWebSocket:typeof window<"u"?d=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(d=self.WebSocket||self.MozWebSocket);var M=d;async function E(e){if(!e)throw new Error("No URL provided. Did you forget to configure the client?");let t=new M(e);return new Promise((o,i)=>{t.addEventListener("open",()=>{o(t)}),t.addEventListener("error",n=>{i(n)})})}async function m(e,t){e.send(JSON.stringify(t))}function b(e,t,o){return new Promise((i,n)=>{let r=o!=null?setTimeout(()=>{n(new u("Timeout waiting for function result exceeded"))},o):null,a=f=>{try{let c=JSON.parse(f.data.toString());if(!I(c,t))return;if(r!=null&&clearTimeout(r),c.error){let x=c.error.name==="FlayerError"?y:Error,W=new x(c.error.message);n(W)}else i(c.data);e.removeEventListener("message",a)}catch{}};e.addEventListener("message",a),e.addEventListener("close",()=>{e.removeEventListener("message",a)})})}function I(e,t){return Object.keys(t).every(o=>e?.[o]===t[o])}var s={date:"@Date",map:"@Map",set:"@Set",bigInt:"@BigInt",regExp:"@RegExp",function:"@Function",special:"@SpecialValue",error:"@Error"};function N(e){return Array.isArray(e)&&e.length===2&&Object.values(s).includes(e[0])}var h=0;function z(e,t){let o=h++,i=async n=>{let r=JSON.parse(n.data);if(r.type!=="callback"||r.id!==o)return;let a=l(r.args,e),f=await t(...a);e.send(JSON.stringify({type:"callback",id:o,data:p(f,e)}))};return e.addEventListener("message",i),e.addEventListener("close",()=>{e.removeEventListener("message",i)}),o}function p(e,t){try{return JSON.stringify(e,(i,n)=>{if(typeof n=="object"&&!(n instanceof Map)&&!(n instanceof Set)&&!(n instanceof RegExp)&&n!=null){let r=Array.isArray(n)?[...n]:{...n};for(let a in n)n[a]instanceof Date&&(r[a]=[s.date,n[a].toISOString()]);return r}if(n instanceof Map){let r=p(Array.from(n.entries()),t);return[s.map,r]}if(n instanceof Set){let r=p(Array.from(n.values()),t);return[s.set,r]}if(n instanceof RegExp)return[s.regExp,[n.source,n.flags]];if(n instanceof Error)return[s.error,n.message];if(typeof n=="bigint")return[s.bigInt,n.toString()];if(typeof n=="function"){let r=z(t,n);return[s.function,r]}return typeof n=="number"&&isNaN(n)?[s.special,"NaN"]:n===1/0?[s.special,"Infinity"]:n===-1/0?[s.special,"-Infinity"]:n})}catch(o){throw new k(o instanceof Error?o.message:"Unknown error")}}function l(e,t){if(!e)return e;try{return JSON.parse(e,(o,i)=>{if(!N(i))return i;let[n,r]=i;switch(n){case s.date:return new Date(r);case s.map:return new Map(l(r,t));case s.set:return new Set(l(r,t));case s.regExp:return new RegExp(r[0],r[1]);case s.error:return new Error(r);case s.bigInt:return BigInt(r);case s.function:let a=async(...f)=>{let c=r;m(t,{type:"callback",id:c,args:p(f,t)});let x=await b(t,{type:"callback",id:c});return l(x,t)};return Object.defineProperty(a,"name",{value:o,writable:!1}),a;case s.special:switch(r){case"NaN":return NaN;case"Infinity":return 1/0;case"-Infinity":return-1/0;default:return i}default:return i}})}catch(o){throw console.error(o),new k(o instanceof Error?o.message:"Unknown error")}}var k=class extends Error{constructor(t){super(`Serialization failed: ${t}`)}};function S(e){return window.flayer[e]}function g(e,t){window.flayer||(window.flayer={invocationId:0,ws:null,config:null}),window.flayer[e]=t}async function P(e,t,o){let i=S("ws");if(!i||i.readyState!==i.OPEN){let f=S("config");if(!f)throw new y("Client not configured");try{i=await E(f.url),g("ws",i)}catch{throw new w("Error connecting to server")}}let n=S("invocationId");g("invocationId",n+1);let r=p(o,i);m(i,{type:"invocation",id:n,modulePath:e,functionName:t,data:r});let a=await b(i,{type:"result",id:n});return l(a,i)}async function U(e){g("config",e),g("ws",await E(e.url))}async function V(){S("ws")?.close(),g("ws",null)}export{U as configure,V as disconnect,P as executeFlayerFunction};
//# sourceMappingURL=index.js.map
