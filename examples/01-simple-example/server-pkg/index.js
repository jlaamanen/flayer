var V=Object.create;var h=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,v=Object.prototype.hasOwnProperty;var K=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var J=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of T(t))!v.call(e,n)&&n!==r&&h(e,n,{get:()=>t[n],enumerable:!(o=L(t,n))||o.enumerable});return e};var U=(e,t,r)=>(r=e!=null?V(D(e)):{},J(t||!e||!e.__esModule?h(r,"default",{value:e,enumerable:!0}):r,e));var R=K((ue,j)=>{var c=null;typeof WebSocket<"u"?c=WebSocket:typeof MozWebSocket<"u"?c=MozWebSocket:typeof global<"u"?c=global.WebSocket||global.MozWebSocket:typeof window<"u"?c=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(c=self.WebSocket||self.MozWebSocket);j.exports=c});var p=class extends Error{},y=class extends p{};var l,P=new Uint8Array(16);function M(){if(!l&&(l=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!l))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return l(P)}var W=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function B(e){return typeof e=="string"&&W.test(e)}var z=B;var a=[];for(g=0;g<256;++g)a.push((g+256).toString(16).substr(1));var g;function H(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=(a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]).toLowerCase();if(!z(r))throw TypeError("Stringified UUID is invalid");return r}var N=H;function _(e,t,r){e=e||{};var o=e.random||(e.rng||M)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){r=r||0;for(var n=0;n<16;++n)t[r+n]=o[n];return t}return N(o)}var k=_;var i={date:"@Date",map:"@Map",set:"@Set",bigInt:"@BigInt",regExp:"@RegExp",function:"@Function",special:"@SpecialValue",error:"@Error"};function $(e){return Array.isArray(e)&&e.length===2&&Object.values(i).includes(e[0])}function C(e,t){return!e&&!t?null:t?e?new Map([...e?Array.from(e):[],...t?Array.from(t):[]]):t:e}function m(e){let t=null;try{return{json:JSON.stringify(e,(o,n)=>{if(typeof n=="object"&&!(n instanceof Map)&&!(n instanceof Set)&&!(n instanceof RegExp)&&n!=null){let s=Array.isArray(n)?[...n]:{...n};for(let f in n)n[f]instanceof Date&&(s[f]=[i.date,n[f].toISOString()]);return s}if(n instanceof Map){let s=m(Array.from(n.entries()));return t=C(t,s.functionMap),[i.map,s.json]}if(n instanceof Set){let s=m(Array.from(n.values()));return t=C(t,s.functionMap),[i.set,s.json]}if(n instanceof RegExp)return[i.regExp,[n.source,n.flags]];if(n instanceof Error)return[i.error,n.message];if(typeof n=="bigint")return[i.bigInt,n.toString()];if(typeof n=="function"){t||(t=new Map);let s=k();return t.set(s,n),[i.function,s]}return typeof n=="number"&&isNaN(n)?[i.special,"NaN"]:n===1/0?[i.special,"Infinity"]:n===-1/0?[i.special,"-Infinity"]:n}),functionMap:t}}catch(r){throw new S(r.message)}}function w(e){if(e==null)return null;try{return JSON.parse(e,(t,r)=>{if(!$(r))return r;let[o,n]=r;switch(o){case i.date:return new Date(n);case i.map:return new Map(w(n));case i.set:return new Set(w(n));case i.regExp:return new RegExp(n[0],n[1]);case i.error:return new Error(n);case i.bigInt:return BigInt(n);case i.function:let s=(...f)=>{console.log("TODO: emit ws message with function id",n)};return Object.defineProperty(s,"name",{value:t,writable:!1}),s;case i.special:switch(n){case"NaN":return NaN;case"Infinity":return 1/0;case"-Infinity":return-1/0;default:return r}default:return r}})}catch{throw new Error("serialization_error")}}var S=class extends Error{constructor(t){super(`Serialization failed: ${t}`)}};var O=U(R());async function I(e){if(!e)throw new Error("No URL provided. Did you forget to configure the client?");let t=new O.default(e);return new Promise((r,o)=>{t.addEventListener("open",()=>{r(t)}),t.addEventListener("error",n=>{o(n)})})}async function A(e,t){e.send(JSON.stringify(t))}async function F(e,t,r){return await new Promise((n,s)=>{let f=r!=null?setTimeout(()=>{s(new y)},r):null,u=d=>{try{let b=JSON.parse(d.data.toString());if(!G(b,t))return;clearTimeout(f),n(b.data),e.removeListener("message",u)}catch{}};e.addEventListener("message",u)})}function G(e,t){return Object.keys(t).every(r=>e?.[r]===t[r])}function E(e){return window.flayer[e]}function x(e,t){window.flayer||(window.flayer={invocationId:0,ws:null,config:null}),window.flayer[e]=t}async function we(e,t,r){let o=E("ws");if(!o){let d=E("config");if(!d)throw new p("Client not configured");o=await I(d.url),x("ws",o)}let n=E("invocationId");x("invocationId",n+1);let{json:s,functionMap:f}=m(r);A(o,{type:"invocation",id:n,modulePath:e,functionName:t,data:s});let u=await F(o,{type:"callback",id:n});return w(u)}async function xe(e){x("config",e),x("ws",await I(e.url))}export{xe as configure,we as executeFlayerFunction};
//# sourceMappingURL=index.js.map
