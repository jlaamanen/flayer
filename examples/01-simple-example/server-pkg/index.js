var T=Object.create;var C=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var P=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var U=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of D(t))!K.call(e,r)&&r!==n&&C(e,r,{get:()=>t[r],enumerable:!(o=j(t,r))||o.enumerable});return e};var B=(e,t,n)=>(n=e!=null?T(J(e)):{},U(t||!e||!e.__esModule?C(n,"default",{value:e,enumerable:!0}):n,e));var R=P((pe,L)=>{var u=null;typeof WebSocket<"u"?u=WebSocket:typeof MozWebSocket<"u"?u=MozWebSocket:typeof global<"u"?u=global.WebSocket||global.MozWebSocket:typeof window<"u"?u=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(u=self.WebSocket||self.MozWebSocket);L.exports=u});var c=class extends Error{},g=class extends c{},m=class extends c{};var w,H=new Uint8Array(16);function E(){if(!w&&(w=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!w))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return w(H)}var N=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function _(e){return typeof e=="string"&&N.test(e)}var v=_;var a=[];for(x=0;x<256;++x)a.push((x+256).toString(16).substr(1));var x;function $(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=(a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]).toLowerCase();if(!v(n))throw TypeError("Stringified UUID is invalid");return n}var z=$;function G(e,t,n){e=e||{};var o=e.random||(e.rng||E)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){n=n||0;for(var r=0;r<16;++r)t[n+r]=o[r];return t}return z(o)}var M=G;var O=B(R());async function I(e){if(!e)throw new Error("No URL provided. Did you forget to configure the client?");let t=new O.default(e);return new Promise((n,o)=>{t.addEventListener("open",()=>{n(t)}),t.addEventListener("error",r=>{o(r)})})}async function b(e,t){e.send(JSON.stringify(t))}async function V(e,t,n){return await new Promise((r,i)=>{let f=n!=null?setTimeout(()=>{i(new g("Timeout waiting for function result exceeded"))},n):null,d=S=>{try{let p=JSON.parse(S.data.toString());if(!X(p,t))return;if(clearTimeout(f),p.error){let F=p.error.name==="FlayerError"?c:Error,A=new F(p.error.message);i(A)}else r(p.data);e.removeEventListener("message",d)}catch{}};e.addEventListener("message",d),e.addEventListener("close",()=>{e.removeEventListener("message",d),i(new c("Client disconnected"))})})}function X(e,t){return Object.keys(t).every(n=>e?.[n]===t[n])}var s={date:"@Date",map:"@Map",set:"@Set",bigInt:"@BigInt",regExp:"@RegExp",function:"@Function",special:"@SpecialValue",error:"@Error"};function q(e){return Array.isArray(e)&&e.length===2&&Object.values(s).includes(e[0])}function Q(e,t){let n=M(),o=async r=>{let i=JSON.parse(r.data);if(i.type!=="callback"||i.id!==n)return;let f=l(i.args,e);await t(...f)};return e.addEventListener("message",o),e.addEventListener("close",()=>{e.removeEventListener("message",o)}),n}function y(e,t){try{return JSON.stringify(e,(o,r)=>{if(typeof r=="object"&&!(r instanceof Map)&&!(r instanceof Set)&&!(r instanceof RegExp)&&r!=null){let i=Array.isArray(r)?[...r]:{...r};for(let f in r)r[f]instanceof Date&&(i[f]=[s.date,r[f].toISOString()]);return i}if(r instanceof Map){let i=y(Array.from(r.entries()),t);return[s.map,i]}if(r instanceof Set){let i=y(Array.from(r.values()),t);return[s.set,i]}if(r instanceof RegExp)return[s.regExp,[r.source,r.flags]];if(r instanceof Error)return[s.error,r.message];if(typeof r=="bigint")return[s.bigInt,r.toString()];if(typeof r=="function"){let i=Q(t,r);return[s.function,i]}return typeof r=="number"&&isNaN(r)?[s.special,"NaN"]:r===1/0?[s.special,"Infinity"]:r===-1/0?[s.special,"-Infinity"]:r})}catch(n){throw new W(n.message)}}function l(e,t){if(e==null)return null;try{return JSON.parse(e,(n,o)=>{if(!q(o))return o;let[r,i]=o;switch(r){case s.date:return new Date(i);case s.map:return new Map(l(i,t));case s.set:return new Set(l(i,t));case s.regExp:return new RegExp(i[0],i[1]);case s.error:return new Error(i);case s.bigInt:return BigInt(i);case s.function:let f=(...d)=>{b(t,{type:"callback",id:i,args:y(d,t)})};return Object.defineProperty(f,"name",{value:n,writable:!1}),f;case s.special:switch(i){case"NaN":return NaN;case"Infinity":return 1/0;case"-Infinity":return-1/0;default:return o}default:return o}})}catch(n){throw console.error(n),new Error("serialization_error")}}var W=class extends Error{constructor(t){super(`Serialization failed: ${t}`)}};function h(e){return window.flayer[e]}function k(e,t){window.flayer||(window.flayer={invocationId:0,ws:null,config:null}),window.flayer[e]=t}async function Se(e,t,n){let o=h("ws");if(!o||o.readyState!==o.OPEN){let d=h("config");if(!d)throw new c("Client not configured");try{o=await I(d.url),k("ws",o)}catch{throw new m("Error connecting to server")}}let r=h("invocationId");k("invocationId",r+1);let i=y(n,o);b(o,{type:"invocation",id:r,modulePath:e,functionName:t,data:i});let f=await V(o,{type:"result",id:r});return l(f,o)}async function Ee(e){k("config",e),k("ws",await I(e.url))}export{Ee as configure,Se as executeFlayerFunction};
//# sourceMappingURL=index.js.map
